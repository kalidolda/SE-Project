<html>
<head>
	<meta charset="UTF-8">
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"
      rel="stylesheet">
    <script type="text/javascript" src="prettify.js"></script>
    <script type="text/javascript" src="data.json"></script>
    <link href="pretty_style.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>

    <body>
        <div id ="maincode">
        </div>
    </body>
</html>

<script>
    const TAG_LI = "<li>";
    const TAG_DIV = "<div>";
    const TAG_OL = "<ol>";
    const TAG_BOLD = "<b>";
    const TAG_PRE = "<pre>";

    var startLine, endLine;

    REUSE = {
        createCodeLine: function(content, lineNumber) {
            var $li = $(TAG_LI).addClass("codeline").append(content)
            $li.data("lineNumber", lineNumber);

            $li.mouseup(function() {
                endLine = $(this).data("lineNumber");
                console.log("Selection is started from line " + startLine + " to line " + endLine);
                createWindow();
            });

            $li.mousedown(function() {
                startLine = $(this).data("lineNumber");
            });

            return $li;
        },
        createCommentLine: function(data, line) {
            var $div = $(TAG_DIV).addClass("codecomment");
            var $span = $(TAG_BOLD).appendTo($div).css({"color" : "purple"});
            $span.text(data["author"]);
            
            $div.append(" - " + data['comment']);
            $div.data("multiply", 5);
			$div.data("full_comment", data['comment']);
            $div.data("lineNumber", line);

			$div.on("click", function() {
                var multiply = $(this).data("multiply");
				$(this).height($(this).height() * multiply);
                $(this).data("multiply", 1 / multiply);
			})
    


            $div.mouseup(function() {
                endLine = $(this).data("lineNumber");
                console.log("Selection is started from line " + startLine + " to line " + endLine);
                createWindow();
            });

            $div.mousedown(function() {
                startLine = $(this).data("lineNumber");
                startLine++;
            });

            return $div;
        }
    }

    var comments = [];

    function SortByEndline(a, b){
        var aIndex = a['end'], bIndex = b['end'];
        return ((aIndex < bIndex) ? -1 : ((aIndex > bIndex) ? 1 : 0));
    }

    function loadAndSortComments(data) {
            $.each( data, function( key, val ) {
                comments.push(val);
            })
            comments.sort(SortByEndline);
    };

    loadAndSortComments(data['comments']);

    function loadLines (data, parent) {
        var $ol = $(TAG_OL).appendTo(parent);
        var line = 1;
        var current = 0;
        $.each( data, function( key, val ) {
            var $pre = $(TAG_PRE).addClass("prettyprint").appendTo($ol);
            $pre.append(REUSE.createCodeLine(val, line));
            while(current < comments.length && comments[current]["end"] == line) {
                $ol.append(REUSE.createCommentLine(comments[current], line));
                current += 1;
            }
            line += 1;
        })
        PR.prettyPrint();
    };

    function createWindow() { 
        var myWindow = window.open("", "MsgWindow", "width=200,height=100");
        // var button =   $('<button/>',
        // {
        //     text: 'Test',
        //     click: function () { alert('hi'); }
        // });


        myWindow.document.write("<p>This is 'MsgWindow'. I am 200px wide and 100px tall!</p>");
        myWindow.document.body.appendChild(button);
        console.log(myWindow);
    }

    loadLines(data["lines"], "#maincode");
</script>
